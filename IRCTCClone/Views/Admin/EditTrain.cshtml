@using IRCTCClone.Models
@using Newtonsoft.Json
@model IRCTCClone.Models.Train

@{
    ViewData["Title"] = "Edit Train";
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

<h2 class="mb-3">Edit Train</h2>

@if (TempData["SuccessMessage"] != null)
{
    <div class="success-popup ">
        <div class="popup-content">
            ✅ @TempData["SuccessMessage"]
        </div>
    </div>
}

@if (TempData["ErrorMessage"] != null)
{
    <div class="success-popup">
        <div class="popup-content">
            ❌ @TempData["ErrorMessage"]
        </div>
    </div>
}

<form asp-action="EditTrain" method="post">
    <input type="hidden" name="Id" value="@Model.Id" />

    <div class="row mb-2">
        <div class="col-md-3">
            <label>Train Number</label>
            <input asp-for="Number" class="form-control" />
        </div>
        <div class="col-md-3">
            <label>Train Name</label>
            <input asp-for="Name" class="form-control" />
        </div>
    </div>

    <div class="row mb-2">
        <div class="col-md-3">
            <label>From Station</label>
@*             <select asp-for="FromStationId" class="form-control">
                @foreach (var s in ViewBag.Stations)
                {
                    <option value="@s.Id" selected="@(s.Id == Model.FromStationId)">
                        @s.Name
                    </option>
                }
            </select> *@

            <select asp-for="FromStationId" asp-items="@(new SelectList((List<Station>)ViewBag.Stations, nameof(Station.Id), nameof(Station.Name)))" class="form-control"></select>

            

        </div>
        <div class="col-md-3">
            <label>To Station</label>
@*             <select asp-for="ToStationId" class="form-control">
                @foreach (var s in ViewBag.Stations)
                {
                    <option value="@s.Id" selected="@(s.Id == Model.ToStationId)">
                        @s.Name
                    </option>
                }
            </select> *@

            <select asp-for="ToStationId" asp-items="@(new SelectList((List<Station>)ViewBag.Stations, nameof(Station.Id), nameof(Station.Name)))" class="form-control"></select>

        </div>
    </div>

    <div class="row mb-2">
        <div class="col-md-3">
            <label>Departure</label>
            <input asp-for="Departure" class="form-control" />
        </div>
        <div class="col-md-3">
            <label>Arrival</label>
            <input asp-for="Arrival" class="form-control" />
        </div>
        <div class="col-md-3">
            <label>Duration</label>
            <input asp-for="Duration" class="form-control" />
        </div>
    </div>

    <!-- Train Classes -->
    <h4 class="mt-4">Train Classes</h4>
    <table id="classTable" class="table table-bordered">
        <thead>
            <tr>
                <th>Class Code</th>
                <th>Seat Prefix</th>
                <th>Fare</th>
                <th>Seats</th>
                <th>Delete</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var cls in (List<IRCTCClone.Models.TrainClass>)ViewBag.TrainClasses)
            {
                <tr>
                    <td class="d-none">
                        <input type="hidden" name="classIds" value="@cls.Id" />
                    </td>
                    <td><input name="classCodes" value="@cls.Code" class="form-control" /></td>
                    <td><input name="SeatPrefix" value="@cls.SeatPrefix" class="form-control" /></td>
                    <td><input name="fares" value="@cls.BaseFare" class="form-control" /></td>
                    <td><input name="seats" value="@cls.SeatsAvailable" class="form-control" /></td>
                    <td><button type="button" class="btn btn-danger btn-sm remove-row">X</button></td>
                </tr>
            }
        </tbody>
    </table>

    <button type="button" id="addClassRow" class="btn-add-class">
        + Add Class
    </button>

    <br /><br />
    <button type="submit" class="btn-edit-train"> 
        ✏️ Update Train Details
    </button>

    <br /><br />
    <a asp-action="TrainList" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Back to Train List
    </a>
</form>

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", function () {

                    // --- CLASS TABLE HANDLING ---
                    const classTable = document.querySelector("#classTable tbody");
                    const deletedClassIds = [];

                    // Add new class row
                    document.getElementById("addClassRow").addEventListener("click", function () {
                        const newRow = document.createElement("tr");
                        newRow.innerHTML = `
                            <td class="d-none">
                                <input type="hidden" name="classIds" value="0" />
                            </td>
                            <td><input name="classCodes" class="form-control" placeholder="e.g. 1A, 2A, 3A, SL" required></td>
                            <td><input name="SeatPrefix" class="form-control" placeholder="e.g. H, A, B, S" required></td>
                            <td><input name="fares" type="number" step="0.01" class="form-control" placeholder="Fare" required></td>
                            <td><input name="seats" type="number" class="form-control" placeholder="Seats" required></td>
                            <td><button type="button" class="btn btn-danger btn-sm remove-row">X</button></td>`;
                        classTable.appendChild(newRow);
                    });

                    // Handle row delete + track deleted IDs
                    classTable.addEventListener("click", function (e) {
                        if (e.target.classList.contains("remove-row")) {
                            const row = e.target.closest("tr");
                            const classIdInput = row.querySelector('input[name="classIds"]');
                            if (classIdInput && classIdInput.value && classIdInput.value !== "0") {
                                deletedClassIds.push(classIdInput.value);
                            }
                            row.remove();
                        }
                    });

                    // Add hidden field before form submit
                    document.querySelector("form").addEventListener("submit", function () {
                        const hiddenInput = document.createElement("input");
                        hiddenInput.type = "hidden";
                        hiddenInput.name = "deletedClassIds";
                        hiddenInput.value = deletedClassIds.join(",");
                        this.appendChild(hiddenInput);
                    });

                    // --- SUCCESS POPUP FADE ---
                    const popup = document.querySelector(".success-popup");
                    if (popup) {
                        const popupContent = popup.querySelector(".popup-content");

                        // Start fade out after 2 seconds
                        setTimeout(() => {
                            popupContent.classList.add("fade-out");
                            // Hide after fade completes
                            setTimeout(() => {
                                popup.style.display = "none";
                            }, 1000);
                        }, 2000);
                    }
                });
    </script>
}

