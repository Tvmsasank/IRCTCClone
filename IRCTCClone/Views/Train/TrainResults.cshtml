@model IEnumerable<IRCTCClone.Models.Train>
@using IRCTCClone.E_D

@{
    ViewData["Title"] = "Train Results";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var journey = ViewBag.JourneyDate ?? DateTime.Today.ToString("yyyy-MM-dd");
    // var fromStation = ViewBag.From;
    // var toStation = ViewBag.To;

    var fromStation = TempData.Peek("FromStation")?.ToString();
    var toStation = TempData.Peek("ToStation")?.ToString();

    var userfromid = TempData.Peek("fromStationId");
    var usertoid = TempData.Peek("toStationId");


    // TempData.Keep();

}

<section class="results-page fadeInUp">
    <div class="results-container">

         <!-- ✅ SEARCH SUMMARY BAR (ADD HERE) -->
        @{
            DateTime jd = DateTime.Today;

            if (ViewBag.JourneyDate != null)
            {
                DateTime.TryParse(ViewBag.JourneyDate.ToString(), out jd);
            }
        }


        <div class="search-summary">

            <div class="route-line">
                <span class="station">@fromStation</span>
                <span class="arrow">→</span>
                <span class="station">@toStation</span>
            </div>

            <div class="date-line">
                <button class="nav-btn" onclick="changeDate(-1)">&#8249;</button>

                <input type="date"
                       id="journeyDatePicker"
                       value="@jd.ToString("yyyy-MM-dd")"
                       onchange="submitDateChange()" />

                <button class="nav-btn" onclick="changeDate(1)">&#8250;</button>

                <span class="day">@jd.ToString("dddd")</span>

                <a href="/Train/TrainResults?
                    fromStationId=@userfromid
                    &toStationId=@usertoid
                    &FromStation=@fromStation
                    &ToStation=@toStation
                    &journeyDateStr=@journey"
                   class="modify-btn"> 
                    Modify Search
                </a>
            </div>

        </div>
        <!-- ✅ END SEARCH SUMMARY BAR --> 

        <h2 class="results-title">
            Available Trains for <span class="highlight">@journey</span>
        </h2>

        @if (Model == null || !Model.Any())
        {
            <p class="no-results">No trains found for your selected route.</p>
        }
        else
        {
            <div class="table-wrapper">
                <div class="train-card-list">
                    @foreach (var t in Model)
                    {
                        <div class="train-card">

                            <!-- Header -->
                            <div class="train-card-header">
                                <div>
                                    <strong>@t.Number - @t.Name</strong><br />
                                </div>

                                <a href="#"
                                   class="train-link view-route"
                                   data-train-id="@t.Id"
                                   data-train-name="@t.Name"
                                   data-train-number="@t.Number">
                                    Train Route
                                </a>
                            </div>

                            <!-- Body -->
                            <div class="train-card-body">
                                <div class="station-block">
                                    <div class="station-name">@t.FSM</div>
                                    <div class="station-time">@t.Departure.ToString(@"hh\:mm")</div>
                                </div>

                                <div class="duration-block">
                                    <span>@t.Duration</span>
                                </div>

                                <div class="station-block">
                                    <div class="station-name">@t.TSM</div>
                                    <div class="station-time">@t.Arrival.ToString(@"hh\:mm")</div>
                                </div>
                            </div>

                            <!-- Classes -->
                            <div class="train-card-classes">
                                @foreach (var c in t.Classes)
                                {
                                    <form method="get" action="/Booking/PrepareCheckout" class="class-card">

                                        <input type="hidden" name="trainId" value="@t.Id" />
                                        <input type="hidden" name="classId" value="@c.Id" />
                                        <input type="hidden" name="journeyDate" value="@journey" />

                                        <input type="hidden" name="userfromid" value="@userfromid" />
                                        <input type="hidden" name="usertoid" value="@usertoid" />

                                        <input type="hidden" name="FromStationId" value="@t.FromStationId" />
                                        <input type="hidden" name="ToStationId" value="@t.ToStationId" />

                                        <input type="hidden" name="FromStation" value="@fromStation" />
                                        <input type="hidden" name="ToStation" value="@toStation" />

                                        <input type="hidden" name="Departure" value="@t.Departure.ToString(@"hh\:mm")" />
                                        <input type="hidden" name="Arrival" value="@t.Arrival.ToString(@"hh\:mm")" />
                                        <input type="hidden" name="Duration" value="@t.Duration" />
                                        <input type="hidden" name="FSM" value="@t.FSM" />
                                        <input type="hidden" name="TSM" value="@t.TSM" />

                                        @{
                                            string seatStatus;
                                            string seatColor;
                                            if (c.SeatsAvailable > 0)
                                            {
                                                seatStatus = "AVAILABLE - " + c.SeatsAvailable;
                                                seatColor = "green"; // ✅ Green for available
                                            }
                                            else if (c.RACSeats > 0)
                                            {
                                                seatStatus = "RAC - " + c.RACSeats;
                                                seatColor = "orange"; // ⚠️ Orange for RAC
                                            }
                                            else if (c.WLSeats > 0)
                                            {
                                                seatStatus = "WL - " + c.WLSeats;
                                                seatColor = "red"; // ❌ Red for WL
                                            }
                                            else
                                            {
                                                seatStatus = "Available";
                                                seatColor = "gray"; // Optional fallback
                                            }
                                        }

                                        <div class="class-code">@c.Code</div>
                                        <div class="class-fare">₹@c.BaseFare</div>
                                        <div class="class-status" style="color: @seatColor;">@seatStatus</div>

                                        <input type="hidden" name="seatStatus" value="@seatStatus" />

                                        <button type="submit" class="book-btn">Book</button>
                                    </form>
                                }
                            </div>

                        </div>
                    }
                </div>
            </div>
        }
    </div>




    @if (TempData["RouteMismatch"] != null)
    {
        <div class="modal-overlay">
            <div class="modal-box">

                <h3 class="modal-title">Confirmation</h3>

                <div class="popmodal">
                    You searched trains from
                    <strong>@TempData["SearchedFrom"]</strong> to
                    <strong>@TempData["SearchedTo"]</strong>,<br />
                    but the selected train runs from
                    <strong>@TempData["ActualFrom"]</strong> to
                    <strong>@TempData["ActualTo"]</strong>.<br /><br />
                    Do you want to continue booking with the actual route?
                </div>

                <div class="modalbutton">
                    <a href="/Booking/Checkout" class="btnmodal yes">✔ Yes</a>
                    <a href="/Train/ClearRouteMismatch" class="btnmodal no" id="closeRouteMismatch"><strong>X</strong> No</a>
                </div>

            </div>
        </div>
    }



    <!-- ✅ Right Side Drawer -->
    <div id="route-sidebar" class="route-sidebar">
        <div class="sidebar-header">
            <h4 class="sidebar-title">Train Route</h4>
            <button class="sidebar-close" id="close-sidebar">&times;</button>
        </div>

        <div id="sidebar-content" class="sidebar-content">
            <!-- AJAX Loaded Route -->
        </div>
    </div>

    <!-- Background Overlay -->
    <div id="sidebar-overlay" class="sidebar-overlay"></div>

</section> 


@section Scripts {

    <!-- Bootstrap JS REQUIRED for modal -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        $(document).on("click", ".train-link", function (e) {
            e.preventDefault();

            var trainId = $(this).data("train-id");
            var trainName = $(this).data("train-name");
            var trainNumber = $(this).data("train-number");

            $(".sidebar-title").text(`Train Route of ${trainNumber} - ${trainName}`);

            $.get("/Admin/GetTrainRoute", { trainId: trainId }, function (html) {

                $("#sidebar-content").html(html);

                $("#sidebar-overlay").fadeIn(200);
                $("#route-sidebar").css("right", "0");
            });
        });

        $(document).on("click", "#close-sidebar, #sidebar-overlay", function () {
            $("#route-sidebar").css("right", "-600px");
            $("#sidebar-overlay").fadeOut(200);
        });

        //         document.addEventListener("click", function (e) {
        //     if (e.target.id === "closeRouteMismatch") {
        //         e.preventDefault();
        //         document.querySelector(".modal-overlay").remove();
        //     }
        // });

        function changeDate(offset) {
            let dateInput = document.getElementById("journeyDatePicker");
            let date = new Date(dateInput.value);
            date.setDate(date.getDate() + offset);
            dateInput.valueAsDate = date;
            submitDateChange();
        }

        function submitDateChange() {
            let date = document.getElementById("journeyDatePicker").value;

            let fromId = '@TempData.Peek("fromStationId")';
            let toId   = '@TempData.Peek("toStationId")';
            let fromNm = '@TempData.Peek("FromStation")';
            let toNm   = '@TempData.Peek("ToStation")';

            let url = `/Train/TrainResults?
                fromStationId=${fromId}
                &toStationId=${toId}
                &FromStation=${encodeURIComponent(fromNm)}
                &ToStation=${encodeURIComponent(toNm)}
                &journeyDateStr=${date}`;

            window.location.href = url;
        }

    </script>


}

