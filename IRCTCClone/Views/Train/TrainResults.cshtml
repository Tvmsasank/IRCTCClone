@model IEnumerable<IRCTCClone.Models.Train>
@using IRCTCClone.E_D

@{
    string encryptedDate = UrlEncryptionHelper.Encrypt(ViewBag.JourneyDate.ToString());
}

@{
    ViewData["Title"] = "Train Results";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var journey = ViewBag.JourneyDate ?? DateTime.Today.ToString("yyyy-MM-dd");
    var fromStation = ViewBag.From;
    var toStation = ViewBag.To;
}


<section class="results-page fadeInUp">
    <div class="results-container">
        <h2 class="results-title">
            Available Trains for <span class="highlight">@journey</span>
        </h2>

        @if (!Model.Any())
        {
            <p class="no-results">No trains found for your selected route.</p>
        }
        else
        {
            <div class="table-wrapper">
                <table class="train-table">
                    <thead>
                        <tr>
                            <th>Number</th>
                            <th>Name</th>
                            <th>From</th>
                            <th>Departure</th>
                            <th>Duration</th>
                            <th>To</th>
                            <th>Arrival</th>
                            <th>Classes</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var t in Model)
                        {
                            <tr>
                                <td><strong>@t.Number</strong></td>

                                <td>
                                    <a href="#" class="train-link"
                                       data-train-id="@t.Id"
                                       data-train-name="@t.Name"
                                       data-train-number="@t.Number"><strong>
                                        @t.Name</strong>
                                    </a>
                                </td>

                                <td><strong>@t.FromStationName1</strong></td>
                                <td><strong>@t.Departure.ToString(@"hh\:mm")</strong></td>
                                <td>@t.Duration</td>
                                <td><strong>@t.ToStationName1</strong></td>
                                <td><strong>@t.Arrival.ToString(@"hh\:mm")</strong></td>

                                <td>
                                    <div class="class-scroll">
                                        <div class="class-buttons">
                                            @foreach (var c in t.Classes)
                                            {
                                                <form method="get" action="/Booking/CheckoutPost" class="inline-form">
                                                    <input type="hidden" name="trainId" value="@t.Id" />
                                                    <input type="hidden" name="classId" value="@c.Id" />
                                                    <input type="hidden" name="journeyDate" value="@journey" />

                                                    <input type="hidden" name="FromStationId" value="@t.FromStationId" />
                                                    <input type="hidden" name="FromStation" value="@fromStation" />
                                                    <input type="hidden" name="ToStation" value="@toStation" />
                                                    <input type="hidden" name="ToStationId" value="@t.ToStationId" />


                                                    <input type="hidden" name="FromStationName1" value="@t.FromStationName1" />
                                                    <input type="hidden" name="ToStationName1" value="@t.ToStationName1" />


                                                    <button type="submit" class="class-btn">
                                                        @{
                                                            string seatStatus;

                                                            if (c.SeatsAvailable > 0)
                                                            {
                                                                seatStatus = "AVAILABLE - " + c.SeatsAvailable;
                                                            }
                                                            else if (c.RACSeats > 0)
                                                            {
                                                                seatStatus = "RAC - " + c.RACSeats; // <-- show count
                                                            }
                                                            else if (c.WLSeats > 0) 
                                                            {
                                                                seatStatus = "WL - " + c.WLSeats;
                                                            }
                                                            else
                                                            {
                                                                seatStatus = "Available - ";
                                                            }
                                                        }
                                                        @c.Code - ₹@c.BaseFare (@seatStatus)
                                                    </button>
                                                    <input type="hidden" name="seatStatus" value="@seatStatus" />
                                                </form>
                                            }
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    </div>




    @if (TempData["RouteMismatch"] != null)
    {
        <div class="modal-overlay">
            <div class="modal-box">

                <h3 class="modal-title">Confirmation</h3>

                <div class="popmodal">
                    You searched trains from
                    <strong>@TempData["SearchedFrom"]</strong> to
                    <strong>@TempData["SearchedTo"]</strong>,<br />
                    but the selected train runs from
                    <strong>@TempData["ActualFrom"]</strong> to
                    <strong>@TempData["ActualTo"]</strong>.<br /><br />
                    Do you want to continue booking with the actual route?
                </div>

                <div class="modalbutton">
                    <a href="/Booking/Checkout" class="btnmodal yes">✔ Yes</a>
                    <a href="#" class="btnmodal no" id="closeRouteMismatch"><strong>X</strong> No</a>
                </div>

            </div>
        </div>
    }



    <!-- ✅ Right Side Drawer -->
    <div id="route-sidebar" class="route-sidebar">
        <div class="sidebar-header">
            <h4 class="sidebar-title">Train Route</h4>
            <button class="sidebar-close" id="close-sidebar">&times;</button>
        </div>

        <div id="sidebar-content" class="sidebar-content">
            <!-- AJAX Loaded Route -->
        </div>
    </div>

    <!-- Background Overlay -->
    <div id="sidebar-overlay" class="sidebar-overlay"></div>

</section> 


@section Scripts {

    <!-- Bootstrap JS REQUIRED for modal -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        $(document).on("click", ".train-link", function (e) {
            e.preventDefault();

            var trainId = $(this).data("train-id");
            var trainName = $(this).data("train-name");
            var trainNumber = $(this).data("train-number");

            $(".sidebar-title").text(`Train Route of ${trainNumber} - ${trainName}`);

            $.get("/Admin/GetTrainRoute", { trainId: trainId }, function (html) {

                $("#sidebar-content").html(html);

                $("#sidebar-overlay").fadeIn(200);
                $("#route-sidebar").css("right", "0");
            });
        });

        $(document).on("click", "#close-sidebar, #sidebar-overlay", function () {
            $("#route-sidebar").css("right", "-450px");
            $("#sidebar-overlay").fadeOut(200);
        });

                document.addEventListener("click", function (e) {
            if (e.target.id === "closeRouteMismatch") {
                e.preventDefault();
                document.querySelector(".modal-overlay").remove();
            }
        });

            // document.addEventListener("DOMContentLoaded", function () {
            //     var modal = new bootstrap.Modal(document.getElementById('routeMismatchModal'));
            //     modal.show();
            // });



    </script>


}

