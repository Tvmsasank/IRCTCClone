@model IEnumerable<IRCTCClone.Models.Train>
@using IRCTCClone.E_D

@{
    string encryptedDate = UrlEncryptionHelper.Encrypt(ViewBag.JourneyDate.ToString());
}

@{
    ViewData["Title"] = "Train Results";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var journey = ViewBag.JourneyDate ?? DateTime.Today.ToString("yyyy-MM-dd");
}

<section class="results-page fadeInUp">
    <div class="results-container">
        <h2 class="results-title">
            Available Trains for <span class="highlight">@journey</span>
        </h2>

        @if (!Model.Any())
        {
            <p class="no-results">No trains found for your selected route.</p>
        }
        else
        {
            <div class="table-wrapper">
                <table class="train-table">
                    <thead>
                        <tr>
                            <th>Number</th>
                            <th>Name</th>
                            <th>From</th>
                            <th>Departure</th>
                            <th>Duration</th>
                            <th>To</th>
                            <th>Arrival</th>
                            <th>Classes</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var t in Model)
                        {
                            <tr>
                                <td>@t.Number</td>

                                <td>
                                    <a href="#" class="train-link"
                                       data-train-id="@t.Id"
                                       data-train-name="@t.Name"
                                       data-train-number="@t.Number">
                                        @t.Name
                                    </a>
                                </td>

                                <td>@t.FromStationName1</td>
                                <td>@t.Departure.ToString(@"hh\:mm")</td>
                                <td>@t.Duration.Substring(0,5)</td>
                                <td>@t.ToStationName1</td>
                                <td>@t.Arrival.ToString(@"hh\:mm")</td>

                                <td>
                                    <div class="class-scroll">
                                        <div class="class-buttons">
                                            @foreach (var c in t.Classes)
                                            {
                                                <form method="get" action="/Booking/Checkout" class="inline-form">
                                                    <input type="hidden" name="trainId" value="@t.Id" />
                                                    <input type="hidden" name="classId" value="@c.Id" />
                                                    <input type="hidden" name="journeyDate" value="@journey" />

                                                    <input type="hidden" name="FromStationId" value="@t.FromStationId" />
                                                    <input type="hidden" name="ToStationId" value="@t.ToStationId" />

                                                    <button type="submit" class="class-btn">
                                                        @{
                                                            string seatStatus;

                                                            if (c.SeatsAvailable > 0)
                                                            {
                                                                seatStatus = "AVAILABLE - " + c.SeatsAvailable;
                                                            }
                                                            else if (c.SeatsAvailable == 0)
                                                            {
                                                                seatStatus = "RAC";
                                                            }
                                                            else
                                                            {
                                                                seatStatus = "WL " + Math.Abs(c.SeatsAvailable);
                                                            }
                                                        }

                                                        @c.Code - ₹@c.BaseFare (@seatStatus)
                                                    </button>
                                                </form>
                                            }
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    </div>

    <!-- ✅ Right Side Drawer -->
    <div id="route-sidebar" class="route-sidebar">
        <div class="sidebar-header">
            <h4 class="sidebar-title">Train Route</h4>
            <button class="sidebar-close" id="close-sidebar">&times;</button>
        </div>

        <div id="sidebar-content" class="sidebar-content">
            <!-- AJAX Loaded Route -->
        </div>
    </div>

    <!-- Background Overlay -->
    <div id="sidebar-overlay" class="sidebar-overlay"></div>

</section>


@section Scripts {
    <script>
        $(document).on("click", ".train-link", function (e) {
            e.preventDefault();

            var trainId = $(this).data("train-id");
            var trainName = $(this).data("train-name");
            var trainNumber = $(this).data("train-number");

            // Update Sidebar Title
            $(".sidebar-title").text(`Train Route of ${trainNumber} - ${trainName}`);

            // Load via AJAX
            $.get("/Admin/GetTrainRoute", { trainId: trainId }, function (html) {

                $("#sidebar-content").html(html);

                $("#sidebar-overlay").fadeIn(200);
                $("#route-sidebar").css("right", "0");
            });
        });

        // Close sidebar
        $(document).on("click", "#close-sidebar, #sidebar-overlay", function () {
            $("#route-sidebar").css("right", "-450px");
            $("#sidebar-overlay").fadeOut(200);
        });
    </script>
}
