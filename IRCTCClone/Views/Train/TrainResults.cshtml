@model IEnumerable<IRCTCClone.Models.Train>
@using IRCTCClone.E_D

@{
    ViewData["Title"] = "Train Results";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var journey = ViewBag.JourneyDate ?? DateTime.Today.ToString("yyyy-MM-dd");
    // var fromStation = ViewBag.From;
    // var toStation = ViewBag.To;

    var fromStation = TempData["FromStation"]?.ToString();
    var toStation = TempData["ToStation"]?.ToString();

    var userfromid= TempData["fromStationId"];
    var usertoid= TempData["toStationId"] ;

    TempData.Keep();

}

<style>
    .train-card {
        background: var(--card-bg);
        border: 1px solid var(--irctc-blue-border);
        border-left: 5px solid var(--irctc-blue);
        border-radius: 6px;
        margin-bottom: 20px;
        padding: 16px;
        box-shadow: 0 2px 6px rgba(26, 79, 163, 0.08);
    }

    .train-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-bottom: 10px;
        border-bottom: 1px solid var(--irctc-blue-border);
    }

        .train-card-header strong {
            color: var(--irctc-blue);
            font-size: 16px;
        }

    .runs-on {
        color: #555;
        font-size: 13px;
    }

    .view-route {
        color: var(--irctc-blue);
        font-weight: 500;
        text-decoration: none;
    }

        .view-route:hover {
            text-decoration: underline;
        }


    .train-card-body {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: var(--irctc-blue-light);
        border-radius: 4px;
        padding: 12px;
        margin: 14px 0;
    }

    .station-name {
        color: var(--irctc-blue);
        font-weight: 600;
    }

    .station-time {
        font-size: 18px;
        color: #000;
    }

    .duration-block span {
        background: #fff;
        border: 1px solid var(--irctc-blue-border);
        padding: 6px 14px;
        border-radius: 20px;
        color: var(--irctc-blue);
        font-weight: 500;
    }

    .train-card-classes {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
    }

    .class-card {
        border: 1px solid var(--irctc-blue-border);
        border-radius: 5px;
        padding: 10px;
        width: 160px;
        background: #f9fbff;
        transition: all 0.2s ease;
    }

        .class-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(26, 79, 163, 0.15);
        }

    .class-code {
        font-weight: bold;
    }

    .class-fare {
        color: #2e7d32;
    }

    .class-status {
        font-size: 13px;
        margin: 6px 0;
    }

    .book-btn {
        background: #ff6f00;
        color: #fff;
        border: none;
        padding: 6px 12px;
        border-radius: 3px;
        cursor: pointer;
    }

    body {
        background: var(--page-bg);
    }

    :root {
        --irctc-blue: #1a4fa3;
        --irctc-blue-light: #e8f0fe;
        --irctc-blue-border: #c7d7f5;
        --success-green: #2e7d32;
        --warning-orange: #ef6c00;
        --danger-red: #c62828;
        --card-bg: #ffffff;
        --page-bg: #f4f8ff;
    }

    .search-summary {
        background: linear-gradient(135deg, #0b4da2, #1e88e5);
        color: #fff;
        padding: 14px 20px;
        border-radius: 8px;
        margin-bottom: 20px;
    }

    .route-line {
        font-size: 18px;
        font-weight: 600;
    }

    .arrow {
        margin: 0 10px;
    }

    .date-line {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-top: 8px;
    }

    .nav-btn {
        background: #ffffff33;
        border: none;
        color: #fff;
        font-size: 18px;
        padding: 4px 10px;
        cursor: pointer;
        border-radius: 4px;
    }

    .modify-btn {
        margin-left: auto;
        background: #fff;
        color: #0b4da2;
        padding: 5px 12px;
        border-radius: 4px;
        text-decoration: none;
        font-weight: 600;
    }

    input[type="date"] {
        padding: 4px 6px;
        border-radius: 4px;
        border: none;
    }


</style>

<section class="results-page fadeInUp">
    <div class="results-container">

        <!-- ✅ SEARCH SUMMARY BAR (ADD HERE) -->
        @{
            DateTime jd = DateTime.Parse(ViewBag.JourneyDate);
        }

        <div class="search-summary">

            <div class="route-line">
                <span class="station">@fromStation</span>
                <span class="arrow">→</span>
                <span class="station">@toStation</span>
            </div>

            <div class="date-line">
                <button class="nav-btn" onclick="changeDate(-1)">&#8249;</button>

                <input type="date"
                       id="journeyDatePicker"
                       value="@jd.ToString("yyyy-MM-dd")"
                       onchange="submitDateChange()" />

                <button class="nav-btn" onclick="changeDate(1)">&#8250;</button>

                <span class="day">@jd.ToString("dddd")</span>

                <a href="/Train/Search" class="modify-btn">Modify Search</a>
            </div>

        </div>
        <!-- ✅ END SEARCH SUMMARY BAR -->

        <h2 class="results-title">
            Available Trains for <span class="highlight">@journey</span>
        </h2>

        @if (!Model.Any())
        {
            <p class="no-results">No trains found for your selected route.</p>
        }
        else
        {
            <div class="table-wrapper">
                <div class="train-card-list">
                    @foreach (var t in Model)
                    {
                        <div class="train-card">

                            <!-- Header -->
                            <div class="train-card-header">
                                <div>
                                    <strong>@t.Number - @t.Name</strong><br />
                                </div>

                                <a href="#"
                                   class="train-link view-route"
                                   data-train-id="@t.Id"
                                   data-train-name="@t.Name"
                                   data-train-number="@t.Number">
                                    Train Route
                                </a>
                            </div>

                            <!-- Body -->
                            <div class="train-card-body">
                                <div class="station-block">
                                    <div class="station-name">@t.FSM</div>
                                    <div class="station-time">@t.Departure.ToString(@"hh\:mm")</div>
                                </div>

                                <div class="duration-block">
                                    <span>@t.Duration</span>
                                </div>

                                <div class="station-block">
                                    <div class="station-name">@t.TSM</div>
                                    <div class="station-time">@t.Arrival.ToString(@"hh\:mm")</div>
                                </div>
                            </div>

                            <!-- Classes -->
                            <div class="train-card-classes">
                                @foreach (var c in t.Classes)
                                {
                                    <form method="get" action="/Booking/PrepareCheckout" class="class-card">

                                        <input type="hidden" name="trainId" value="@t.Id" />
                                        <input type="hidden" name="classId" value="@c.Id" />
                                        <input type="hidden" name="journeyDate" value="@journey" />

                                        <input type="hidden" name="userfromid" value="@userfromid" />
                                        <input type="hidden" name="usertoid" value="@usertoid" />

                                        <input type="hidden" name="FromStationId" value="@t.FromStationId" />
                                        <input type="hidden" name="ToStationId" value="@t.ToStationId" />

                                        <input type="hidden" name="FromStation" value="@fromStation" />
                                        <input type="hidden" name="ToStation" value="@toStation" />

                                        <input type="hidden" name="Departure" value="@t.Departure.ToString(@"hh\:mm")" />
                                        <input type="hidden" name="Arrival" value="@t.Arrival.ToString(@"hh\:mm")" />
                                        <input type="hidden" name="Duration" value="@t.Duration" />
                                        <input type="hidden" name="FSM" value="@t.FSM" />
                                        <input type="hidden" name="TSM" value="@t.TSM" />

                                        @{
                                            string seatStatus;
                                            if (c.SeatsAvailable > 0)
                                                seatStatus = "AVAILABLE - " + c.SeatsAvailable;
                                            else if (c.RACSeats > 0)
                                                seatStatus = "RAC - " + c.RACSeats;
                                            else if (c.WLSeats > 0)
                                                seatStatus = "WL - " + c.WLSeats;
                                            else
                                                seatStatus = "Available";
                                        }

                                        <div class="class-code">@c.Code</div>
                                        <div class="class-fare">₹@c.BaseFare</div>
                                        <div class="class-status">@seatStatus</div>

                                        <input type="hidden" name="seatStatus" value="@seatStatus" />

                                        <button type="submit" class="book-btn">Book</button>
                                    </form>
                                }
                            </div>

                        </div>
                    }
                </div>
            </div>
        }
    </div>




    @if (TempData["RouteMismatch"] != null)
    {
        <div class="modal-overlay">
            <div class="modal-box">

                <h3 class="modal-title">Confirmation</h3>

                <div class="popmodal">
                    You searched trains from
                    <strong>@TempData["SearchedFrom"]</strong> to
                    <strong>@TempData["SearchedTo"]</strong>,<br />
                    but the selected train runs from
                    <strong>@TempData["ActualFrom"]</strong> to
                    <strong>@TempData["ActualTo"]</strong>.<br /><br />
                    Do you want to continue booking with the actual route?
                </div>

                <div class="modalbutton">
                    <a href="/Booking/Checkout" class="btnmodal yes">✔ Yes</a>
                     <a href="/Train/TrainResults" class="btnmodal no" id="closeRouteMismatch"><strong>X</strong> No</a>
                </div>

            </div>
        </div>
    }



    <!-- ✅ Right Side Drawer -->
    <div id="route-sidebar" class="route-sidebar">
        <div class="sidebar-header">
            <h4 class="sidebar-title">Train Route</h4>
            <button class="sidebar-close" id="close-sidebar">&times;</button>
        </div>

        <div id="sidebar-content" class="sidebar-content">
            <!-- AJAX Loaded Route -->
        </div>
    </div>

    <!-- Background Overlay -->
    <div id="sidebar-overlay" class="sidebar-overlay"></div>

</section> 


@section Scripts {

    <!-- Bootstrap JS REQUIRED for modal -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        $(document).on("click", ".train-link", function (e) {
            e.preventDefault();

            var trainId = $(this).data("train-id");
            var trainName = $(this).data("train-name");
            var trainNumber = $(this).data("train-number");

            $(".sidebar-title").text(`Train Route of ${trainNumber} - ${trainName}`);

            $.get("/Admin/GetTrainRoute", { trainId: trainId }, function (html) {

                $("#sidebar-content").html(html);

                $("#sidebar-overlay").fadeIn(200);
                $("#route-sidebar").css("right", "0");
            });
        });

        $(document).on("click", "#close-sidebar, #sidebar-overlay", function () {
            $("#route-sidebar").css("right", "-600px");
            $("#sidebar-overlay").fadeOut(200);
        });

                document.addEventListener("click", function (e) {
            if (e.target.id === "closeRouteMismatch") {
                e.preventDefault();
                document.querySelector(".modal-overlay").remove();
            }
        });

            // document.addEventListener("DOMContentLoaded", function () {
            //     var modal = new bootstrap.Modal(document.getElementById('routeMismatchModal'));
            //     modal.show();
            // });


                    function changeDate(offset) {
            let dateInput = document.getElementById("journeyDatePicker");
            let date = new Date(dateInput.value);
            date.setDate(date.getDate() + offset);
            dateInput.valueAsDate = date;
            submitDateChange();
        }

        function submitDateChange() {
            let date = document.getElementById("journeyDatePicker").value;

            let url = `/Train/TrainResults?journeyDate=${date}`;
            window.location.href = url;
        }



    </script>


}

