@model IRCTCClone.Models.Train

@{
    ViewData["Title"] = "Booking Details";
}

@{
    var train = ViewBag.Train as IRCTCClone.Models.Train;
    var cls = ViewBag.Class as IRCTCClone.Models.TrainClass;
    var journey = ViewBag.JourneyDate as string ?? DateTime.Today.ToString("yyyy-MM-dd");
}
    
<section class="checkout-page">
    <div class="checkout-card">
        <h2>Booking Details</h2>

@if (train != null && cls != null)
{
    <div class="train-info">
        <p><strong>Train:</strong> @train.Number - @train.Name</p>
        <p><strong>Class:</strong> @cls.Code, Fare: ₹@cls.BaseFare</p>
        <p><strong>Route:</strong> @train.FromStation?.Name (@train.FromStation?.Code) → @train.ToStation?.Name (@train.ToStation?.Code)</p>
        <p>
            <strong>Departure:</strong> @train.Departure.ToString(@"hh\:mm") |
            <strong>Arrival:</strong> @train.Arrival.ToString(@"hh\:mm") |
            <strong>Duration:</strong> @train.Duration.ToString(@"hh\:mm")
        </p>
    </div>
            <form method="post" action="/Booking/Confirm" class="checkout-form">
                <input type="hidden" name="trainId" value="@train.Id" />
                <input type="hidden" name="classId" value="@cls.Id" />
                <input type="hidden" name="journeyDate" value="@journey" />
                <input type="hidden" name="trainName" value="@train.Name" />
                <input type="hidden" name="trainNumber" value="@train.Number" />
                <input type="hidden" name="Class" value="@cls.Code" />
                <input type="hidden" name="FromStationId" value="@train.FromStationId" />
                <input type="hidden" name="ToStationId" value="@train.ToStationId" />

                <div class="form-group mb-3">
                    <label for="Quota">Select Quota:</label>
                    <select name="Quota" class="form-control" required>
                        <option value="GENERAL">General</option>
                        <option value="TATKAL">Tatkal</option>
                        <option value="LADIES">Ladies</option>
                        <option value="SENIOR CITIZEN">Senior Citizen</option>
                    </select>
                </div>

                <h3>Passengers</h3>

                <div id="passengers">
                    <div class="passenger-card">
                        <input name="passengerNames" placeholder="Name" required />
                        <input name="passengerAges" type="number" placeholder="Age" min="1" oninput="validity.valid||(value='');" required />
                        <select name="passengerGenders" required>
                            <option value="">Select Gender</option>
                            <option value="M">Male</option>
                            <option value="F">Female</option>
                            <option value="O">Others</option>
                        </select>
                        <select name="passengerBerths" required>
                            <option value="">Select Berth</option>
                            <option value="LB">Lower Berth</option>
                            <option value="MB">Middle Berth</option>
                            <option value="UB">Upper Berth</option>
                            <option value="SL">Side Lower</option>
                            <option value="SU">Side Upper</option>
                            <option value="WS">Window Side</option>
                            <option value="AS">Aisle</option>
                        </select>
                        <button type="button" class="remove-passenger">❌</button>
                    </div>
                </div>
                <button type="button" id="addPassenger" class="btn btn-primary mb-2">+ Add Passenger</button>

                <p class="total-fare">
                    Total Fare: ₹<span id="totalFare" data-fare="@cls.BaseFare">@cls.BaseFare</span>
                </p>
                <button type="submit" class="btn-primary">Pay & Book (Mock)</button>
            </form>

}
else
{
    <p class="error-msg">Error: Train or Class data not found.</p>
}
</div>
</section>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script> 
    $(function () {
        // --- Update Total Fare ---
        function updateTotal() {
            var fare = parseFloat($("#totalFare").data("fare") || 0);
            var count = $("#passengers .passenger-card").length;
            $("#totalFare").text((count * fare).toFixed(2));
        }

        // --- Add Passenger ---
        $("#addPassenger").on("click", function () {
            var passengerHtml = `
                <div class="passenger-card">
                    <input name="passengerNames" placeholder="Name" required />
                    <input name="passengerAges" type="number" placeholder="Age" min="1" oninput="validity.valid||(value='');" required />
                            <select name="passengerGenders" required>
                        <option value="">Select Gender</option>
                        <option value="M">Male</option>
                        <option value="F">Female</option>
                        <option value="O">Other</option>
                    </select>
                    <select name="passengerBerths" required>
                        <option value="">Select Berth</option>
                        <option value="LB">Lower Berth</option>
                        <option value="MB">Middle Berth</option>
                        <option value="UB">Upper Berth</option>
                        <option value="SL">Side Lower</option>
                        <option value="SU">Side Upper</option>
                        <option value="WS">Window Side</option>
                        <option value="AS">Aisle</option>
                    </select>
                    <button type="button" class="remove-passenger">❌</button>
                </div>
            `;
            $("#passengers").append(passengerHtml);
            updateTotal();
        });

        // --- Remove Passenger (Delegated Event) ---
        $(document).on("click", ".remove-passenger", function () {
            $(this).closest(".passenger-card").remove();
            updateTotal();
        });

        $(document).on("input", "input[name='passengerAges']", function () {
            let val = parseInt($(this).val());
            if (val < 1 || isNaN(val)) {
                $(this).val("");
            }
        });



        // --- Initial Fare Update ---
        updateTotal();
    });
</script>
