@model IRCTCClone.Models.Booking
@using IRCTCClone.E_D

@{
    ViewData["Title"] = "Booking Details";
}

@{
    var train = ViewBag.Train as IRCTCClone.Models.Train;
    var cls = ViewBag.Class as IRCTCClone.Models.TrainClass;
    var journey = ViewBag.JourneyDate as string ?? DateTime.Today.ToString("yyyy-MM-dd");
    var frmst = ViewBag.FromStation;
    var tost = ViewBag.ToStation;
    var FromStation1 = ViewBag.FromStation1;
    var ToStation1 = ViewBag.ToStation1;


    var Departure= ViewBag.Departure;
    var Arrival=ViewBag.Arrival;
    var Duration=ViewBag.Duration;


 }
    

<section class="checkout-page">
    <div class="checkout-card">
        <h2>Booking Details</h2>

        @if (train != null && cls != null)
        {
            <div class="train-info">
                <p><strong>Train:</strong> @train.Number - @train.Name</p>
                <p><strong>Class:</strong> @cls.Code, Fare: ₹@cls.BaseFare</p>
                <p><strong>Route:</strong> @FromStation1 → @ToStation1</p>
        
                <p><strong>Boarding Date:</strong> @train.JourneyDate?.ToString("dd-MM-yyyy")</p>

                <p>
                    <strong>Departure:</strong> @Departure |
                    <strong>Arrival:</strong> @Arrival |
                    <strong>Duration:</strong> @Duration
                </p>
            </div>
            <form method="post" action="/Booking/Confirm" class="checkout-form">
                <!-- 🔐 ENCRYPTED BOOKING DATA -->
 @*               <input type="hidden" name="edata" value="@ViewBag.EncryptedData" />
                <input type="hidden" name="trainId" value="@train.Id" />
                <input type="hidden" name="classId" value="@cls.Id" />
                <input type="hidden" name="journeyDate" value="@journey" />
                <input type="hidden" name="trainName" value="@train.Name" />
                <input type="hidden" name="trainNumber" value="@train.Number" />
                <input type="hidden" name="Class" value="@cls.Code" />
                <input type="hidden" name="FromStationId" value="@ViewBag.FromStationId" />
                <input type="hidden" name="ToStationId" value="@ViewBag.ToStationId" />
                <input type="hidden" name="SeatStatuscount" value="@ViewBag.SeatStatusCount" />
                <input type="hidden" name="BookingStatus" value="@ViewBag.BookingStatus" /> *@

                <input type="hidden" name="edata" value="@ViewBag.EncryptedData" />

                <div class="form-group mb-3">
                    <label for="Quota"><strong>Select Quota:</strong></label>
                    <select name="Quota" class="form-control" required>
                        <option value="GENERAL">General</option>
                        <option value="TATKAL">Tatkal</option>
                        <option value="LADIES">Ladies</option>
                        <option value="SENIOR CITIZEN">Senior Citizen</option>
                    </select>
                </div>

                <h3>Passengers</h3>

                <div id="passengers">
                    <div class="passenger-card">
                        <input name="passengerNames" placeholder="Name" required />
                        <input name="passengerAges" type="number" placeholder="Age" min="1" oninput="validity.valid||(value='');" required />
                        <select name="passengerGenders" required>
                            <option value="">Select Gender</option>
                            <option value="M">Male</option>
                            <option value="F">Female</option>
                            <option value="O">Others</option>
                        </select>
                        <select name="passengerBerths" required>
                            <option value="">Select Berth</option>
                            <option value="LB">Lower Berth</option>
                            <option value="MB">Middle Berth</option>
                            <option value="UB">Upper Berth</option>
                            <option value="SL">Side Lower</option>
                            <option value="SU">Side Upper</option>
                            <option value="WS">Window Side</option>
                            <option value="AS">Aisle</option>
                        </select>
                        <button type="button" class="remove-passenger">❌</button>
                    </div>
                </div>
                <button type="button" id="addPassenger" class="btn btn-primary mb-2">+ Add Passenger</button>

                <p class="total-fare">
                    Total Fare: ₹<span id="totalFare" data-fare="@cls.BaseFare">@cls.BaseFare</span>
                </p>
                <input type="hidden" name="edata" value="@ViewBag.EncryptedData" />

                <!-- ✅ CAPTCHA BLOCK START -->
                <label>
                    Captcha
                    <div style="display:flex; align-items:center; gap:10px; margin-top:6px;">
                        <img id="captchaImg"
                             src="/captcha"
                             alt="Captcha"
                             style="border:1px solid #ccc; height:40px;" />

                        <button type="button"
                                onclick="refreshCaptcha()"
                                style="padding:4px 8px; cursor:pointer;">
                            ↻
                        </button>
                    </div>

                    <!-- 🔴 NAME MUST MATCH ViewModel -->
                    <input type="text"
                           name="CaptchaInput"
                           placeholder="Enter captcha"
                           required />
                </label>
                <!-- ✅ CAPTCHA BLOCK END -->


                <button type="button" id="payBookBtn" class="btn-primary">Pay & Book</button>
            </form>

            <div id="otpOverlay" class="otp-overlay">
                <div class="otp-box">
                    <h3>OTP Verification</h3>
                    <p>An OTP has been sent to your registered email.<br>Please enter it to continue booking.</p>

                    <input type="text" id="otpInput" maxlength="6" placeholder="Enter 6-digit OTP" />
                    <div class="otp-error"></div>

                    <div class="otp-actions">
                        <button type="button" id="verifyOtpBtn">Verify OTP</button>
                        <button type="button" id="cancelOtpBtn">Cancel</button>
                    </div>
                </div>
            </div>
        }
        else
        {
            <p class="error-msg">Error: Train or Class data not found.</p>
        }
    </div>
</section>


<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script> 
    $(function () {
        // --- Update Total Fare ---
        function updateTotal() {
            var fare = parseFloat($("#totalFare").data("fare") || 0);
            var count = $("#passengers .passenger-card").length;
            $("#totalFare").text((count * fare).toFixed(2));
        }

        // --- Add Passenger ---
        $("#addPassenger").on("click", function () {
            var passengerHtml = `
                <div class="passenger-card">
                    <input name="passengerNames" placeholder="Name" required />
                    <input name="passengerAges" type="number" placeholder="Age" min="1" oninput="validity.valid||(value='');" required />
                            <select name="passengerGenders" required>
                        <option value="">Select Gender</option>
                        <option value="M">Male</option>
                        <option value="F">Female</option>
                        <option value="O">Other</option>
                    </select>
                    <select name="passengerBerths" required>
                        <option value="">Select Berth</option>
                        <option value="LB">Lower Berth</option>
                        <option value="MB">Middle Berth</option>
                        <option value="UB">Upper Berth</option>
                        <option value="SL">Side Lower</option>
                        <option value="SU">Side Upper</option>
                        <option value="WS">Window Side</option>
                        <option value="AS">Aisle</option>
                    </select>
                    <button type="button" class="remove-passenger">❌</button>
                </div>
            `;
            $("#passengers").append(passengerHtml);
            updateTotal();
        });

        // --- Remove Passenger (Delegated Event) ---
        $(document).on("click", ".remove-passenger", function () {
            $(this).closest(".passenger-card").remove();
            updateTotal();
        });

        $(document).on("input", "input[name='passengerAges']", function () {
            let val = parseInt($(this).val());
            if (val < 1 || isNaN(val)) {
                $(this).val("");
            }
        });

        // --- Initial Fare Update ---
        updateTotal();

        //----------otp starts------
        let otpRequested = false;

        $("#payBookBtn").on("click", function () {

            $.ajax({
                url: "/Booking/RequestOtp",
                type: "POST",
                data: $(".checkout-form").serialize(),
                success: function (res) {
                    if (res.success) {
                        $("#otpOverlay").fadeIn();
                    } else {
                        alert("Failed to send OTP");
                    }
                },
                error: function () {
                    alert("OTP request failed");
                }
            });

        });

        $("#verifyOtpBtn").on("click", function () {

            let otp = $("#otpInput").val();

            if (otp.length !== 6) {
                $(".otp-error").text("Please enter a valid 6-digit OTP");
                return;
            }

            $("<input>").attr({
                type: "hidden",
                name: "otp",
                value: otp
            }).appendTo(".checkout-form");

            $(".checkout-form").submit();
        });


    });

            function refreshCaptcha() {
            document.getElementById("captchaImg").src =
            "/captcha?ts=" + new Date().getTime();
        }

        // ✅ Load captcha on page load
        refreshCaptcha();

</script>
